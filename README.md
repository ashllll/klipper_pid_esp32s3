# ESP32-S3 PID 温控系统 (带 OLED UI)

基于 ESP32-S3 微控制器，结合 FreeRTOS 实时操作系统，实现对加热器的精确 PID 温度控制。系统带有自动调谐功能，并通过 SSD1306 OLED 显示屏和旋转编码器提供用户交互界面。

## 功能特点

- **精确 PID 温度控制**：使用 NTC 热敏电阻和 ADS1115 ADC 进行温度采样，通过 PID 算法控制加热器 PWM 输出，维持目标温度。
- **自动 PID 调谐**：集成 PID_AutoTune_v0 库，可自动计算优化的 PID 参数 (Kp, Ki, Kd)。
- **OLED 用户界面**：使用 U8g2 库驱动 SSD1306 (128x64) 显示屏，提供多页面信息展示和设置菜单。
    - **主页多屏显示**: 旋转编码器切换显示主要控制信息 (PID 温度/设定点/PWM) 和 传感器/参数信息 (SHT40 温湿度/NTC 电压/PID 参数)。
    - **设置菜单**: 通过编码器按下进入，可调整目标温度，并预留手动触发调谐的选项。
- **环境温湿度监测**: 集成 SHT40 传感器，读取环境温度和湿度并在 UI 上显示。
- **旋转编码器输入**: 使用 GyverEncoder 库处理带按钮的 EC11 编码器输入，用于导航和确认操作。
- **数据持久化**：使用 ESP32 Preferences (NVS) 保存自动调谐得到的 PID 参数，避免每次重启后重新调谐。
- **多任务实时系统**：基于 FreeRTOS 将传感器读取、PID 控制、PWM 输出、编码器输入、UI 显示分离到独立任务，确保系统响应性和稳定性。
- **EMA 滤波**: 对 NTC 温度读数应用指数移动平均滤波，减少噪声干扰。

## 硬件要求

- **主控**: Seeed Studio XIAO ESP32-S3 (或同等 ESP32-S3 开发板)
- **PID 温度传感器**: NTC 100K 热敏电阻
- **高精度 ADC**: Adafruit ADS1115 (或其他兼容型号)
- **环境传感器**: Adafruit SHT40 (或其他兼容型号)
- **显示屏**: SSD1306 OLED 显示屏 (128x64, I2C 接口)
- **用户输入**: EC11 旋转编码器 (带按钮)
- **加热器驱动**: N-MOSFET 模块 (或固态继电器 SSR)
- **加热器**: 12V 或 24V PTC 加热器 (或其他类型加热器)
- **电源**: 适配加热器和 ESP32 的电源

## 引脚定义 (基于 `src/main.cpp` 当前配置)

| 功能             | 引脚 (XIAO ESP32S3) | GPIO  | 说明                                   |
|-----------------|---------------------|-------|----------------------------------------|
| I²C SDA         | D4                  | GPIO5 | 连接 ADS1115, SHT40, SSD1306 的 SDA    |
| I²C SCL         | D5                  | GPIO6 | 连接 ADS1115, SHT40, SSD1306 的 SCL    |
| 旋转编码器 A 相   | D0                  | GPIO1 | 编码器旋转检测                         |
| 旋转编码器 B 相   | D1                  | GPIO2 | 编码器旋转检测                         |
| 旋转编码器按钮    | D2                  | GPIO3 | 编码器按钮输入 (单击确认, 双击返回)       |
| 加热器 PWM       | D10                 | GPIO10| 连接 MOSFET 栅极 (控制加热器)           |

**注意:** 请根据你的实际接线仔细检查并修改代码中的引脚定义。特别是 PWM 输出引脚。

## 项目结构

- `src/main.cpp`: 主程序文件，包含所有任务逻辑 (传感器、控制、PWM、编码器、UI) 和设置代码。
- `platformio.ini`: PlatformIO 项目配置文件，包含库依赖和构建设置。
- `include/`: 可能包含一些自定义头文件（当前代码似乎没有）。
- `lib/`: PlatformIO 自动下载的库依赖文件夹 (被 `.gitignore` 忽略)。
- `.gitignore`: 指定 Git 忽略的文件和目录。
- `README.md`: 本文件。

## 使用方法

### 编译与烧录

1.  确保已安装 PlatformIO IDE (VSCode 扩展或 Core)。
2.  克隆或下载本项目。
3.  使用 PlatformIO 打开项目文件夹。
4.  PlatformIO 会自动检测 `platformio.ini` 并安装所需库 (如 U8g2, Adafruit ADS1X15, Adafruit SHT4x, GyverEncoder, PID_AutoTune_v0, Preferences)。
5.  连接 ESP32-S3 开发板到电脑。
6.  在 PlatformIO 中选择正确的串口 (Upload Port)。
7.  点击 "Build" (编译) 和 "Upload" (上传)。

### 硬件连接

按照 **引脚定义** 部分将所有传感器、显示屏、编码器和 MOSFET 连接到 ESP32-S3。确保 I2C 设备地址正确 (SSD1306 通常是 0x3C, ADS1115 可配置，SHT40 通常是 0x44)。

### 操作指南

通过旋转编码器与 OLED 屏幕进行交互：

- **主界面 (Home Screen):**
    - **旋转编码器**: 在不同的信息页面之间切换。
        - **页面 1**: 显示 PID 控制信息 (当前温度 T, 设定温度 S, PWM 百分比及进度条)。
        - **页面 2**: 显示传感器信息和参数 (SHT40 温湿度, NTC 电压, Kp/Ki/Kd 值)。
    - **单击编码器按钮**: 进入设置菜单。
- **设置菜单 (Settings Menu):**
    - **旋转编码器**: 在菜单项之间移动 (由 `>` 符号指示)。
    - **单击编码器按钮**: 确认选择。
        - **选择 "Target Temp"**: 进入目标温度编辑界面。
        - **选择 "Start Tune"**: (当前可能未完全实现手动触发逻辑) 尝试启动 PID 自动调谐。
        - **选择 "Exit"**: 返回主界面。
    - **双击编码器按钮**: 从菜单返回主界面 (或在编辑界面返回菜单)。
- **目标温度编辑界面 (Edit Setpoint):**
    - **旋转编码器**: 增加或减少目标温度值 (步进 0.5°C)。
    - **单击编码器按钮**: 保存新的目标温度并返回设置菜单。
    - **双击编码器按钮**: 取消编辑并返回设置菜单。

## 自动调谐过程

1.  **首次启动或 NVS 清除后**: 系统会自动进入初始加热 (`STATE_INITIAL_HEATING`)，然后等待温度稳定 (`STATE_WAITING_FOR_STABILITY`)，最后进入自动调谐 (`STATE_TUNING`)。
2.  **手动触发 (如果 UI 支持)**: 在设置菜单中选择 "Start Tune"。
3.  **调谐执行**: 系统使用继电器法 (Relay method) 控制加热器，使温度在目标温度附近产生振荡。
4.  **参数计算**: 库根据振荡特性计算出 Kp, Ki, Kd 参数。
5.  **保存与应用**: 计算出的参数会自动保存到 NVS (非易失性存储)，并立即应用于 PID 控制器。系统随后进入正常运行状态 (`STATE_RUNNING`)。
6.  **后续启动**: 如果 NVS 中已存有 PID 参数，系统将跳过自动调谐，直接加载参数并进入运行状态。

## 注意事项

- **首次使用**: 建议先让系统完成一次自动调谐，以获得适用于你加热系统的 PID 参数。确保在**常用的目标工作温度**下进行调谐。
- **NVS 清除**: 如果更换了加热器或系统表现不佳，可能需要清除 NVS 中的旧参数并重新调谐。可以通过在 `setup()` 函数中临时添加 `preferences.clear();` 并运行一次来实现。**记得之后移除该行代码！**
- **传感器连接**: 确保 NTC 和 SHT40 传感器连接牢固且 I2C 地址无冲突。温度测量不准确会严重影响 PID 控制效果。
- **调谐参数 (`aTuneStep`, `aTuneNoise`)**: 如果自动调谐效果不佳（如无法完成、超调严重、参数奇怪），可能需要调整 `main.cpp` 中的 `aTuneStep` 和 `aTuneNoise` 参数。`aTuneStep` 控制调谐时的 PWM 输出强度，`aTuneNoise` 定义了忽略的温度波动范围。

## 许可证

本项目采用 MIT 许可证。 