# ESP32-S3 PID 温控系统

基于 ESP32-S3 的智能 PID 温控系统，结合 FreeRTOS，实现对 PTC 加热器的精准温度控制与自动调谐功能。

## 功能特点

- **精确温度控制**：使用经典 PID 控制算法实现稳定的温度控制
- **自动调谐功能**：基于 Ziegler-Nichols 方法的 PID 参数自动调整
- **多任务实时系统**：基于 FreeRTOS 的任务管理，确保控制及时性
- **用户界面**：旋转编码器输入，串口命令控制
- **数据持久化**：使用 ESP32 Preferences 保存 PID 参数和目标温度
- **安全保护**：温度超限保护，传感器故障检测

## 硬件要求

- Seeed Studio XIAO ESP32-S3
- ADS1115 16位 ADC 转换器
- NTC 100KΩ 温度传感器
- EC11 旋转编码器
- N-MOSFET 或继电器用于控制加热器
- 12V PTC 加热器

## 引脚定义

| 功能             | 引脚   | 说明                    |
|-----------------|-------|------------------------|
| I²C SDA         | GPIO5 | 连接 ADS1115 SDA        |
| I²C SCL         | GPIO6 | 连接 ADS1115 SCL        |
| 旋转编码器 A 相   | GPIO1 | 编码器旋转检测          |
| 旋转编码器 B 相   | GPIO2 | 编码器旋转检测          |
| 旋转编码器按钮    | GPIO3 | 编码器按钮输入          |
| 加热器 PWM       | GPIO10| 加热器控制输出          |

## 项目结构

- `src/`: 源代码文件
  - `main.cpp`: 主程序入口，FreeRTOS 任务创建
  - `pid.cpp`: PID 控制器实现
  - `autotune.cpp`: 自动调谐实现
  - `ntc.cpp`: 温度传感器驱动
  - `encoder.cpp`: 旋转编码器驱动
- `include/`: 头文件
  - `config.hpp`: 系统配置参数
  - `pid.hpp`: PID 控制器接口
  - `autotune.hpp`: 自动调谐接口
  - `ntc.hpp`: 温度传感器接口
  - `encoder.hpp`: 旋转编码器接口
- `lib/`: 库文件
  - `ADS1115/`: ADS1115 驱动库

## 使用方法

### 编译与烧录

1. 使用 PlatformIO 打开项目
2. 选择 `seeed_xiao_esp32s3` 开发板
3. 编译并上传

### 硬件连接

1. 将 ADS1115 连接到 ESP32-S3 的 I²C 引脚 (SDA: GPIO5, SCL: GPIO6)
2. 将 NTC 传感器连接到 ADS1115 的 A0 通道
3. 将旋转编码器的 A 相、B 相和按钮分别连接到 GPIO1、GPIO2 和 GPIO3
4. 将 MOSFET 的栅极连接到 GPIO10 (PWM 输出)

### 操作指南

#### 旋转编码器控制

- **旋转**：顺时针/逆时针旋转调整目标温度
- **短按**：切换加热器开/关状态
- **长按**：进入/退出自动调谐模式

#### 串口命令

通过 115200 波特率的串口连接，可以发送以下命令：

- `SET:x`：设置目标温度为 x °C (例如：`SET:100`)
- `STATUS`：显示当前状态信息
- `ENABLE`：开启加热器
- `DISABLE`：关闭加热器
- `PID:p,i,d`：手动设置 PID 参数 (例如：`PID:10,0.4,40`)
- `ATUNE`：启动自动调谐
- `ATUNE:STOP`：停止自动调谐
- `SAVE`：保存当前设置
- `LOAD`：加载保存的设置
- `RESET`：重置 PID 控制器
- `HELP`：显示帮助信息

## 自动调谐过程

1. 长按编码器按钮或发送 `ATUNE` 命令启动自动调谐
2. 系统将执行 Bang-Bang 控制，使温度在目标温度附近震荡
3. 收集足够的峰/谷温度数据后，自动计算最佳 PID 参数
4. 参数计算完成后，系统自动保存参数并返回正常控制模式

## 注意事项

- 初次使用时，请先执行自动调谐以获得最佳 PID 参数
- 请确保 NTC 传感器安装牢固，保证温度测量准确性
- 系统默认的目标温度为 100°C，可通过设置更改
- 如遇温度测量异常，请检查 ADS1115 和 NTC 传感器连接

## 开发者说明

- PID 控制器基于 Klipper 固件的 PID 控制逻辑
- 调整 PID 参数时，可参考以下经验值：
  - 对于 100W PTC 加热器：Kp ≈ 10.0, Ki ≈ 0.4, Kd ≈ 40.0

## 许可证

本项目采用 MIT 许可证 